<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="shortcut icon" type="x-icon" href="/css/exp.png">
    <title>Expense Tracker App</title>
    <link rel="stylesheet" href="/css/expense.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>
    <div class="contain">
        <nav>
            <div class="logo">Expense Tracker</div>
            <div id="prime">
                <button id="razor-pay" class="btn">Buy Premium</button>
            </div>
            <h3 id="navName"></h3>
            <button class="btn2">Logout</button>
        </nav>
        <form class="form" onsubmit="saveEx(event)">
            <label class="form-label">Expense Amount</label>
            <input id="amount" type="number" name="amount" required />
            <label class="form-label">Description</label>
            <input id="description" type="text" name="description" required />
            <label class="form-label">Choose a Category</label>
            <select id="category" name="category" required>
                <option value="">Select a Category</option>
                <option value="Movie">Movie</option>
                <option value="Food">Food</option>
                <option value="Travel">Travel</option>
                <option value="Fuel">Fuel</option>
            </select>
            <button type="submit" class="btn">Add Expense</button>
        </form>
        <ul id="listofExpense" class="list-group"></ul>
        <ul id="leaderboarddata" class="list-group"></ul>
        <button onclick="download()">Download File</button>
        <button onclick="downloadUrls()">Show Download Urls</button>
        <ul id="downloadUrl" class="list-group"></ul>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script>
        document.getElementById("razor-pay").onclick = async function (e) {
            const token = localStorage.getItem('token')
            const response = await axios.get('http://localhost:4500/purchase/premiummembership', { headers: { "Authorization": token } })
            console.log(response)
            var options = {
                "key": response.data.key_id,
                "order_id": response.data.order.id,
                "handler": async function (response) {
                    const res = await axios.post('http://localhost:4500/purchase/updatetranstatus', {
                        order_id: options.order_id,
                        payment_id: response.razorpay_payment_id,
                    }, { headers: { "Authorization": token } })
                        .then((res) => {
                            alert('You are a Premier User Now')
                            document.getElementById('razor-pay').style.visibility = 'hidden'
                            showLeaderboard()
                            console.log("alialiali")
                            localStorage.setItem('token', res.data.token)
                        }).catch(err => console.log(err))
                }
            }
            const rzp1 = new Razorpay(options);
            rzp1.open();
            e.preventDefault();

            rzp1.on('payment.failed', function (response) {
                console.log(response);
                alert('Something went wrong')
            });
        }

        function saveEx(event) {
            event.preventDefault();
            const token = localStorage.getItem('token')
            const amount = event.target.amount.value;
            const description = event.target.description.value;
            const category = event.target.category.value;
            const userId = localStorage.getItem('userId')
            const obj = {
                amount,
                description,
                category,
                userId
            }
            axios.post("http://localhost:4500/expense/add-expense", obj, { headers: { "Authorization": token } })
                .then((response) => {
                    console.log(response);
                    showExpense(response.data.addExpense);
                })
                .catch(err => console.log(err))
            event.target.reset();
        }

        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        window.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('token')
            const decoded = parseJwt(token);
            document.getElementById('navName').textContent = decoded.name;
            const premium = decoded.ispremiumuser;
            if (premium) {
                document.getElementById('razor-pay').style.visibility = 'hidden';
                showLeaderboard()
            }
            axios.get("http://localhost:4500/expense/get-expense", { headers: { "Authorization": token } })
                .then((response) => {
                    console.log(response);
                    for (var i = 0; i < response.data.allExpense.length; i++) {
                        showExpense(response.data.allExpense[i]);
                    }
                })
                .catch(err => console.log(err))
        })

        function showExpense(obj) {
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('category').value = '';

            const parentNode = document.getElementById('listofExpense');
            const childHTML = `<li id=${obj.id}> ${obj.amount}â‚¹ - ${obj.description} - ${obj.category}
                                <button onclick=deleteExpense('${obj.id}')> Delete </button>
                                <button onclick="editExpense('${obj.amount}', '${obj.description}', '${obj.category}', '${obj.id}')"> Edit </button></li>`;

            parentNode.innerHTML = parentNode.innerHTML + childHTML;
        }

        function editExpense(amount, description, category, id) {
            document.getElementById('amount').value = amount;
            document.getElementById('description').value = description;
            document.getElementById('category').value = category;
            deleteExpense(id);
        }

        function deleteExpense(id) {
            axios.delete(`http://localhost:4500/expense/delete-expense/${id}`)
                .then((response) => {
                    removeExpenseFromScreen(id)
                })
                .catch(err => console.log(err))
        }

        function removeExpenseFromScreen(id) {
            const parentNode = document.getElementById('listofExpense');
            const childNodeToBeDeleted = document.getElementById(id);
            if (childNodeToBeDeleted) {
                parentNode.removeChild(childNodeToBeDeleted)
            }
        }

        function showLeaderboard() {
            const parentNode = document.getElementById('prime');
            const newChild = '<button id="leaderboard">Show Leaderboard</button>'
            parentNode.innerHTML = parentNode.innerHTML + newChild;
            const leaderboard = document.getElementById('leaderboard')
            leaderboard.onclick = async () => {
                const token = localStorage.getItem('token')
                const leaderboardarray = await axios.get('http://localhost:4500/premium/leaderboard', { headers: { "Authorization": token } })
                var leaderboardElem = document.getElementById('leaderboarddata')
                leaderboardElem.innerHTML = '';
                console.log(leaderboardarray);
                leaderboardElem.innerHTML += '<h2> Leader Board </h2>'
                leaderboardarray.data.forEach((userDetails) => {
                    console.log(userDetails)
                    leaderboardElem.innerHTML += `<li> ${userDetails.name} Total Expense - ${userDetails.totalExpenses}`
                })
            }
        }

        function download() {
            const token = localStorage.getItem('token')
            axios.get('http://localhost:4500/user/download', { headers: { "Authorization": token } })
                .then((response) => {
                    if (response.status === 200) {
                        var a = document.createElement("a");
                        a.href = response.data.fileURL;
                        a.download = 'myexpense.csv';
                        a.click();
                    } else {
                        throw new Error(response.data.message)
                    }
                })
                .catch((err) => {
                    showError(err)
                });
        }

        function downloadUrls() {
            const token = localStorage.getItem('token')
            axios.get('http://localhost:4500/user/downloadurls', { headers: { "Authorization": token } })
            .then((response) => {
                    console.log(response);
                    for (var i = 0; i < response.data.allUrls.length; i++) {
                        showUrl(response.data.allUrls[i]);
                    }
                })
                .catch(err => console.log(err))
        }

        function showUrl(url) {
            const parentNode = document.getElementById('downloadUrl');
            const childHTML = `<li id=${url.id}> ${url.url} - <button> Download </button>`;
            parentNode.innerHTML = parentNode.innerHTML + childHTML;
        }
    </script>
</body>

</html>